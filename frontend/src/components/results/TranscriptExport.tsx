import type { TranscriptMessage, Persona, AnalysisResult } from '../../types';

interface Props {
  messages: TranscriptMessage[];
  personas: Persona[];
  analysis: AnalysisResult;
}

function buildMarkdown(messages: TranscriptMessage[], personas: Persona[], analysis: AnalysisResult): string {
  const lines: string[] = [];

  lines.push('# Council Simulator - Debate Transcript');
  lines.push('');
  lines.push(`**Approval Score:** ${Math.round(analysis.approval_score)}/100 (${analysis.approval_label})`);
  lines.push('');

  // Participants
  lines.push('## Participants');
  lines.push('');
  for (const p of personas) {
    const role = p.role.replace('_', ' ');
    lines.push(`- **${p.name}** — ${role}${p.occupation ? `, ${p.occupation}` : ''}`);
  }
  lines.push('');

  // Transcript
  lines.push('## Transcript');
  lines.push('');

  let lastPhase = '';
  for (const msg of messages) {
    if (msg.phase !== lastPhase) {
      lastPhase = msg.phase;
      lines.push(`### ${msg.phase.replace('_', ' ').toUpperCase()}`);
      lines.push('');
    }
    lines.push(`**${msg.persona_name}:**`);
    lines.push(msg.content);
    lines.push('');
  }

  // Analysis
  lines.push('## Analysis');
  lines.push('');
  lines.push(`**Score:** ${Math.round(analysis.approval_score)}/100`);
  lines.push(`**Verdict:** ${analysis.approval_label}`);
  lines.push(`**Reasoning:** ${analysis.approval_reasoning}`);
  lines.push('');
  lines.push(`**Assessment:** ${analysis.overall_assessment}`);
  lines.push('');

  if (analysis.recommended_rebuttals.length > 0) {
    lines.push('## Recommended Rebuttals');
    lines.push('');
    for (const reb of analysis.recommended_rebuttals) {
      lines.push(`### ${reb.concern}`);
      lines.push(`**Response:** ${reb.rebuttal}`);
      lines.push(`**Supporting Data:** ${reb.supporting_data}`);
      lines.push(`**Effectiveness:** ${reb.effectiveness}`);
      lines.push('');
    }
  }

  lines.push('---');
  lines.push('*Generated by Council Simulator — AI-Powered City Council Debate Simulator*');

  return lines.join('\n');
}

export default function TranscriptExport({ messages, personas, analysis }: Props) {
  const handleExport = () => {
    const markdown = buildMarkdown(messages, personas, analysis);
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'council-simulator-transcript.md';
    a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <button
      onClick={handleExport}
      className="px-6 py-3 rounded-lg border border-chamber-border text-chamber-text font-medium hover:bg-chamber-surface transition-colors"
    >
      Export Transcript
    </button>
  );
}
